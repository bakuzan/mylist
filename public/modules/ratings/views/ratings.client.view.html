<section data-ng-controller="RatingsController" data-ng-init="findItems()" data-ng-show="authentication.user">
    <span keycuts></span>
    <div class="fixed-header width-95 secondary-background">
        <div class="view-controls float-right">
            <li class="tab-control-option" ng-class="(view === 'Anime') ? 'active' : ''" ng-model="view" btn-radio="'Anime'">
                <a>Anime</a>
            </li>
            <li class="tab-control-option" ng-class="(view === 'Manga') ? 'active' : ''" ng-model="view" btn-radio="'Manga'">
                <a>Manga</a>
            </li>
        </div>
        <h1>{{view}} ratings <button class="btn btn-primary show-actions" ng-init="inTheWay = false" ng-click="inTheWay = !inTheWay">Toggle actions</button></h1>
    </div>
    <div class="container relative" style="top: 40px">
        <div class="col-lg-4 col-md-4 col-sm-4 item-filter-container" ng-class="{ 'in-the-way' : inTheWay }" ng-hide="viewItem !== undefined">
            <div class="input-group">
                <div class="input-group-addon">
                    <i class="fa fa-search"></i>
                </div>
               <input type="text" class="form-control" placeholder="search items" ng-model="search" ng-model-options="{ debounce: 700 }">
           </div>
            <div class="input-group mt">
              <div class="input-group-addon">
                  <i class="fa fa-list-ol"></i>
              </div>
                <input type="text" class="form-control" value="Showing {{ (showingCount = (items | filter: search | ratingFilter: ratingLevel).length) }} {{view.toLowerCase()}}." disabled>
            </div>
            <div class="input-group mt">
                <div class="input-group-addon clickable" data-ng-click="ratingLevel=undefined">
                    <i class="fa fa-star"></i>
                </div>
                   <rating class="form-control rating-stars clickable" data-ng-model="ratingLevel" readonly="false" max="maxRating" on-hover="hoveringOver(value)" on-leave="overStar = null" id="rating" name="rating"></rating>
                <div class="input-group-addon">
                    <span data-ng-show="overStar!=null" class="label rating-label" ng-class="{'label-warning': percent<40, 'label-info': percent>=30 && percent<70, 'label-success': percent>=70}">{{percent}}%</span>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-5 col-sm-5 item-placeholder-container"></div>
        <div class="col-lg-8 col-md-6 col-sm-6 item-list-container" loading-spinner name="rating" size="fullscreen">
            <div page-controls page-config="pageConfig" showing-count="showingCount"></div>
            <table class="ratings-table">
                <thead>
                    <th>
                        <a href="" ng-click="sortType = 'status'; sortReverse = !sortReverse ">
                        S
                        </a>
                        <i ng-show="sortType == 'status'" class="fa" ng-class="sortReverse ? 'fa-caret-up' : 'fa-caret-down' "></i>
                    </th>
                    <th class="left">
                        <a href="" ng-click="sortType = 'title'; sortReverse = !sortReverse ">
                        Title
                        </a>
                        <i ng-show="sortType == 'title'" class="fa" ng-class="sortReverse ? 'fa-caret-up' : 'fa-caret-down' "></i>
                    </th><!-- Make ~80% width of table. -->
                    <th>
                        <a href="" ng-click="sortType = 'rating'; sortReverse = !sortReverse ">
                        R
                        </a>
                        <i ng-show="sortType == 'rating'" class="fa" ng-class="sortReverse ? 'fa-caret-up' : 'fa-caret-down' "></i>
                    </th>
                </thead>
                <tbody ng-init="changeRating=false">
                    <tr ng-repeat="item in items | filter: { title: search }:isEqual | ratingFilter: ratingLevel | orderBy: sortType:sortReverse | startFrom: pageConfig.currentPage*pageConfig.pageSize | limitTo: pageConfig.pageSize">
                        <td>
                            <i ng-if="item.status" class="fa fa-check green-text"></i>
                            <i ng-if="!item.status" class="fa fa-minus"></i>
                        </td>
                        <td class="left">
                            <span class="clickable" ng-click="(view==='Anime') ? viewEpisodeRatings(item) : go(item._id)">
                                {{item.title}}
                            </span>
                        </td>
                        <td ng-init="newRating = item.rating">
                            <input type="number" class="small-input phantom-control" min="0" max="{{maxRating}}" ng-model="newRating" 
                                   ng-blur="itemScore(item, newRating)" enter-tag="itemScore(item, newRating)" />
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div class="fixed position-left margin-top-25" style="top: 200px; width: 100vw" ng-show="viewItem !== undefined && search === viewItem.title">
            <h4 class="margin-left-50"><a href="/#!/{{view.toLowerCase()}}items/{{viewItem._id}}" class="clickable">{{viewItem.title}}</a> {{viewItem.rating === 0 ? '' : '- ' + viewItem.rating}}</h4>
            <div class="table-horizontal-container">
                <table class="table-horizontal-scroll">
                    <tbody>
                        <tr>
                            <th>Episode</th>
                            <td class="text-center" ng-repeat="episode in viewItem.meta.history">
                                <span class="display-block">{{episode.value}}</span>
                            </td>
                        </tr>
                        <tr>
                            <th>Ratings</th>
                            <td ng-repeat="episode in viewItem.meta.history">
                                <input type="number" class="phantom-control width-100 text-center" min="0" max="{{maxRating}}" 
                                       ng-model="episode.rating" ng-blur="episodeScore(true)" enter-tag="episodeScore(true)" />
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div>
                <table class="col-lg-2 col-md-2 col-sm-2  margin-left-50 margin-top-10 margin-bottom-10">
                    <tbody>
                        <tr ng-repeat="item in summaryFunctions">
                            <th>{{item.metric}}</th><td>{{item.value}}</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</section>